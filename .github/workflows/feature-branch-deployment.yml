name: Feature Branch Dev Deployment

on:
  workflow_run:
    workflows: ["Helixium Web Validation"]
    types:
      - completed
    branches:
      - "feature/**"
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy (defaults to current branch)"
        required: false

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-southeast-2' }}
  ECS_CLUSTER: "helixium-cluster"
  ECS_DEV_SERVICE: "helixium-dev-service"
  ECS_DEV_TASK_DEFINITION: "helixium-dev"

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    name: 🚀 Deploy to Dev Environment
    if: github.event.workflow_run.conclusion == 'success' && startsWith(github.event.workflow_run.head_branch, 'feature/')
    environment: dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: helixium-web-image
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Load Docker image
        run: |
          echo "📦 Loading Docker image from artifact..."
          docker load < helixium-web-image.tar.gz
          echo "✅ Docker image loaded"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'ap-southeast-2' }}

      - name: Get branch name for tagging
        id: branch-name
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.branch }}" ]; then
            BRANCH_NAME="${{ github.event.inputs.branch }}"
            COMMIT_SHA="${{ github.sha }}"
          else
            BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          fi

          # Clean branch name for Docker tag (replace / with -)
          CLEAN_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g' | tr '[:upper:]' '[:lower:]')
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "clean-branch=$CLEAN_BRANCH" >> $GITHUB_OUTPUT
          echo "image-tag=${CLEAN_BRANCH}-${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "commit-sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      - name: Get ECR repository URL
        id: get-ecr-url
        run: |
          ECR_DEV_REPO_URL=$(aws ecr describe-repositories \
            --repository-names helixium-web-dev \
            --query 'repositories[0].repositoryUri' \
            --output text 2>/dev/null || echo "")

          if [ -n "$ECR_DEV_REPO_URL" ]; then
            echo "ecr-dev-repo-url=$ECR_DEV_REPO_URL" >> $GITHUB_OUTPUT
            echo "✅ Dev ECR repository found: $ECR_DEV_REPO_URL"
          else
            echo "❌ Dev ECR repository not found"
            echo "Please ensure infrastructure is deployed with dev environment"
            exit 1
          fi

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Tag and push image to dev ECR
        run: |
          echo "🏷️  Tagging and pushing image to dev ECR..."

          # Tag the loaded image for ECR
          docker tag helixium-web:${{ steps.branch-name.outputs.commit-sha }} \
            ${{ steps.get-ecr-url.outputs.ecr-dev-repo-url }}:${{ steps.branch-name.outputs.image-tag }}

          docker tag helixium-web:${{ steps.branch-name.outputs.commit-sha }} \
            ${{ steps.get-ecr-url.outputs.ecr-dev-repo-url }}:${{ steps.branch-name.outputs.clean-branch }}-latest

          # Push to ECR
          docker push ${{ steps.get-ecr-url.outputs.ecr-dev-repo-url }}:${{ steps.branch-name.outputs.image-tag }}
          docker push ${{ steps.get-ecr-url.outputs.ecr-dev-repo-url }}:${{ steps.branch-name.outputs.clean-branch }}-latest

          echo "✅ Images pushed to dev ECR"

      - name: Check if dev service exists
        id: check-dev-service
        run: |
          if aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_DEV_SERVICE }} \
            --query 'services[0].status' \
            --output text 2>/dev/null | grep -q ACTIVE; then
            echo "dev-service-exists=true" >> $GITHUB_OUTPUT
            echo "✅ Dev service found and active"
          else
            echo "dev-service-exists=false" >> $GITHUB_OUTPUT
            echo "❌ Dev service not found or not active"
            echo "Please ensure dev infrastructure is deployed"
            exit 1
          fi

      - name: Get current task definition
        id: get-task-def
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_DEV_TASK_DEFINITION }} \
            --query taskDefinition > dev-task-definition.json

      - name: Update dev task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: dev-task-definition.json
          container-name: helixium-web-dev
          image: ${{ steps.get-ecr-url.outputs.ecr-dev-repo-url }}:${{ steps.branch-name.outputs.image-tag }}

      - name: Scale up dev service if needed
        run: |
          # Check current desired count
          CURRENT_COUNT=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_DEV_SERVICE }} \
            --query 'services[0].desiredCount' \
            --output text)

          echo "Current desired count: $CURRENT_COUNT"

          if [ "$CURRENT_COUNT" = "0" ]; then
            echo "🚀 Scaling up dev service from 0 to 1..."
            aws ecs update-service \
              --cluster ${{ env.ECS_CLUSTER }} \
              --service ${{ env.ECS_DEV_SERVICE }} \
              --desired-count 1
            echo "✅ Dev service scaled up"
          else
            echo "✅ Dev service already running"
          fi

      - name: Deploy to dev ECS service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_DEV_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

      - name: Wait for deployment to complete
        run: |
          echo "⏳ Waiting for deployment to stabilize..."
          sleep 60

      - name: Get dev deployment URL
        id: get-dev-url
        run: |
          echo "🔍 Dev environment is available at: https://dev.helixium.nicholasfane.com"
          echo "deployment-url=https://dev.helixium.nicholasfane.com" >> $GITHUB_OUTPUT
          echo "branch-deployed=${{ steps.branch-name.outputs.branch-name }}" >> $GITHUB_OUTPUT

      - name: Test dev deployment
        run: |
          echo "🧪 Testing dev deployment..."
          # Wait a bit more for the load balancer to route traffic
          sleep 30

          # Test the deployment
          MAX_ATTEMPTS=10
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "🔍 Attempt $ATTEMPT/$MAX_ATTEMPTS to reach dev environment..."
            
            if curl -f --connect-timeout 10 --max-time 30 -s "https://dev.helixium.nicholasfane.com" > /dev/null; then
              echo "✅ Dev environment is responding!"
              echo "🌐 Available at: https://dev.helixium.nicholasfane.com"
              break
            else
              echo "⏳ Dev environment not ready yet, waiting..."
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo "⚠️  Dev environment may still be starting up"
                echo "🔗 Check directly: https://dev.helixium.nicholasfane.com"
              else
                sleep 30
              fi
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done

      - name: Development Deployment Summary
        run: |
          echo "📋 Feature Branch Deployment Summary"
          echo "===================================="
          echo ""
          echo "🌿 Branch: ${{ steps.branch-name.outputs.branch-name }}"
          echo "📝 Commit: ${{ steps.branch-name.outputs.commit-sha }}"
          echo "👤 Triggered by: ${{ github.actor }}"
          echo ""
          echo "✅ Dev Deployment: Successful"
          echo "  • Image built and validated ✅"
          echo "  • Image pushed to dev ECR ✅"
          echo "  • ECS service updated ✅"
          echo "  • Deployment verified ✅"
          echo ""
          echo "🌐 Dev Environment: https://dev.helixium.nicholasfane.com"
          echo "📊 Monitor logs: CloudWatch /ecs/helixium-dev"
          echo ""
          echo "💡 Next steps:"
          echo "  1. Test your changes at https://dev.helixium.nicholasfane.com"
          echo "  2. Make additional changes and push to update deployment"
          echo "  3. Create a pull request when ready for review"

      - name: Notify Slack about feature deployment
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "@here 🌿 Feature Branch ✅ Deployed to Dev",
              "blocks": [
                {
                  "type": "header", 
                  "text": {
                    "type": "plain_text",
                    "text": "🌿 Feature Branch ✅ Deployed to Dev"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ steps.branch-name.outputs.branch-name }}"
                    },
                    {
                      "type": "mrkdwn", 
                      "text": "*Commit:*\n${{ steps.branch-name.outputs.commit-sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nDevelopment"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*🌐 Dev Environment:*\nhttps://dev.helixium.nicholasfane.com"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Open Dev Environment"
                      },
                      "url": "https://dev.helixium.nicholasfane.com"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
